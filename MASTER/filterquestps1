#!/bin/php
##
## FilterQuest by UnluckyForSome
## Please see https://github.com/unluckyforsome/filterquest for info.

<?php

$gameList = trim(shell_exec("ls -1"));
$gameArray = explode("\n", $gameList);

shell_exec('mkdir -p Removed');
shell_exec('mkdir -p Process');

foreach($gameArray as $thisGame) {
	if(!$thisGame) continue;
	// Probably already been removed
	if(!file_exists($thisGame)) continue;

	$niceName = trim(preg_replace('%[\(|\[].*%', '', $thisGame));

	// Playstation 1 Multi-Game Demos
        if(preg_match('%\((Asia|Austria|Brazil|China|Denmark|Finland|France|Germany|Greece|Hungary|Israel|Italy|Japan|Korea|Netherlands|Norway|Poland|Portugal|Russia|Scandinavia|Spain|Sweden)\)%', $thisGame)) {
		echo "{$thisGame} is a demo disk. Moved to Removed folder.\n";
		shell_exec("mv \"{$thisGame}\" Removed/");
		continue;
	}

	// Playstation 1 Manual Region Duplicates
				if(preg_match('%\(3, 2, 1, Smurf! My First Racing Game (Europe) (En,Fr,De,Es,It,Nl)|4x4 World Trophy (Europe) (En,Fr,De,Es,It)|A.IV - Evolution Global (Europe) (En,Ja,Fr,De)|Action Man - Mission Xtreme (Europe) (En,Fr,De,Es,It,Nl,Sv,No,Da,Fi) (No EDC)|Actua Golf (Europe) (En,Fr,De)|Actua Golf 2 (Europe)|Actua Soccer (Europe) (En,Fr) (v1.1)|Actua Soccer 2 (Europe) (En,Fr)|Alexi Lalas International Soccer (USA) (En,Fr,De,Es,It)|All Star Tennis (Europe)|Alone in the Dark - Jack Is Back (Europe) (En,Fr,De,Es,It)|Army Men - Land, Sea, Air (Europe) (En,Fr,De,Es,It)|Army Men - Lock 'n' Load (Europe) (En,Fr,De,Es,It)|Army Men - Omega Soldier (Europe) (En,Fr,De,Es,It)|Army Men - Operation Meltdown (Europe) (En,Fr,De,Es,It)|Army Men - Team Assault (Europe) (En,Fr,De,Es,It)|Batman of the Future - Return of the Joker (Europe) (En,Fr,De)|Beach Volleyball (Europe) (En,Fr,De,Es,It)|Blam! Machinehead (Europe)|Breakout - A Story of Bat Meets Ball...! (Europe) (En,Fr,De,It)|C3 Racing - Car Constructors Championship (Europe) (En,Fr,De,Es,It)|Card Shark (Europe)|Dancing Stage - Disney Mix (Europe)|Devil's Deception (Europe) (En,Fr,De)|Disney's Action Game featuring Hercules (Europe)|Disney's Donald Duck - Quack Attack (Europe) (En,Fr,De,It)|Disney's Lilo & Stitch - Trouble in Paradise (Europe)|Disney-Pixar Monsters, Inc. - Scare Island (Europe)|Driver (Europe)|Duke Nukem (Europe)|Equestriad 2001 (Europe) (En,De,Es)|Exhumed (Europe) (En,Fr,De,Es)|Firestorm - Thunderhawk 2 (Europe) (En,Fr)|Fisherman's Bait - Bass Challenge (Europe)|Fisherman's Bait 3 (Europe)|Formula 1 97 (Europe) (En,Fr,De,Es,It) (v1.1)|Gex - Deep Cover Gecko (Europe) (En,Es,It)|Gex 3D - Enter the Gecko (Europe)|Golden Goal 98 (Europe) (En,Fr,De,Es,It)|Hard Edge (Europe) (En,Fr,De)|Harry Potter and the Philosopher's Stone (Europe) (En,Fr,De)|Harry Potter and the Philosopher's Stone (Europe) (En,Nl,Da)|International Track & Field 2 (Europe)|Kileak - The Blood (Europe)|Konami Open Golf (Europe)|Kula World (Europe)|Kurushi (Europe) (En,Fr,De,Es,It)|Le Mans 24 Hours (Europe) (En,Fr,De,Es,It,Pt)|Legend of Kartia (Europe) (En,Fr,De)|Lifeforce Tenka (Europe)|Lomax (Europe) (En,Fr,De,Es,It)|Micro Maniacs (Europe) (En,Fr,De,Es,It)|MoHo (Europe) (En,Fr,De,Es,It)|Monster Trucks (Europe)|Music 2000 (Europe) (En,Fr,De,Es,It)|NBA Pro 98 (Europe)|NBA Pro 99 (Europe)|Need for Speed - Porsche 2000 (Europe) (En,De,Sv)|Need for Speed - Road Challenge (Europe) (En,Es,It)|Need for Speed - Road Challenge (Europe) (En,Sv)|Overboard! (Europe)|Pool Shark (Europe)|Power Serve (Europe) (En,Fr,De)|Prism Land Story (Europe)|Pro Racer (Europe) (v1.1)|Rapid Racer (Europe) (En,Fr,De,Es,It)|Ronin Blade (Europe) (En,Fr,De)|Scooter Racing (Europe)|Shane Warne Cricket (Australia)|Sheep, Dog 'n' Wolf (Europe) (En,Fr,De,Es,It,Nl)|Snowboard Racer (Europe)|Spyro 2 - Gateway to Glimmer (Europe) (En,Fr,De,Es,It)|Super Slammin' Dodgeball (Europe)|Test Drive 4x4 (Europe) (En,Fr,De)|Theme Park World (Europe) (En,Fr,De,Es,It,Nl,Sv)|This Is Soccer (Australia)|This Is Soccer 2 (Australia)|Tiger Woods 99 USA Tour Golf (Australia)|Tiger Woods USA Tour 2000 (Australia)|Tiger Woods USA Tour 2001 (Australia)|Tiny Toon Adventures - Buster and the Beanstalk (Europe) (En,Es,Pt)|Tombi! (Europe) (En,Es,Pt,Sv,Da)|Tombi! (Europe) (En,Fr,De,It,Nl)|Tombi! 2 (Europe)|Tony Hawk's Skateboarding (Europe)|Total Drivin (Europe) (En,Fr,De,Es,It,Pt)|Twisted Metal - World Tour (Europe)|Victory Boxing 2 (Europe)|WipEout 2097 (Europe)|X-COM - Enemy Unknown (Europe) (En,Fr,De,Es,It)\)%', $thisGame)) {
		echo "{$thisGame} has a better release by a different name. Moved to Removed folder.\n";
		shell_exec("mv \"{$thisGame}\" Removed/");
		continue;
	}

	// Non-Engish speaking countries e.g. (France) or (Japan)
        if(preg_match('%\((Asia|Austria|Brazil|China|Denmark|Finland|France|Germany|Greece|Hungary|Israel|Italy|Japan|Korea|Netherlands|Norway|Poland|Portugal|Russia|Scandinavia|Spain|Sweden)\)%', $thisGame)) {
		echo "{$thisGame} is a foreign language release. Moved to Removed folder.\n";
		shell_exec("mv \"{$thisGame}\" Removed/");
		continue;
	}

	// Non-full release e.g. (Demo) or (Kiosk)
        if(preg_match('%\((Demo|Kiosk|Debug|Unl|Sample|Beta|Beta \d+|Developer Cart)\)%', $thisGame)) {
		echo "{$thisGame} is a non-retail release. Moved to Removed folder.\n";
		shell_exec("mv \"{$thisGame}\" Removed/");
		continue;
	}

	// A USA version exists instead, use that
	if(!strstr($thisGame, '(USA)') && !strstr($thisGame, '(Japan, USA)') && !strstr($thisGame, '(USA, Korea)')) {
		// Check for pure USA only version
		$fCheck = trim(shell_exec("ls -1 \"{$niceName} (USA)\"* 2>/dev/null"));
		if($fCheck) {
			echo "{$thisGame} has a better version available. Moved to Removed folder.\n";
			shell_exec("mv \"{$thisGame}\" Removed/");
			continue;
		}

		// Check for USA/Japan version
		$fCheck = trim(shell_exec("ls -1 \"{$niceName} (Japan, USA)\"* 2>/dev/null"));
		if(!$fCheck) $fCheck = trim(shell_exec("ls -1 \"{$niceName} (USA, Korea)\"* 2>/dev/null"));
		if($fCheck) {
			echo "{$thisGame} has a better version available. Moved to Removed folder.\n";
			shell_exec("mv \"{$thisGame}\" Removed/");
			continue;
		}
	}

	// Remove non-English versions e.g. (Se,De,Fr)
	if(preg_match('%\(Europe\).+\(((?:[A-Za-z]{2}[,|\)])+)%', $thisGame, $languageArray)) {
		// Preg match leaves trailing ) so remove it
		$languageArray = explode(',', str_replace(')', '', trim($languageArray[1])));
		if(!in_array('En', $languageArray)) {
			echo "{$thisGame} is a non-english euro release. Moved to Removed folder.\n";
			shell_exec("mv \"{$thisGame}\" Removed/");
			continue;
		}
	}


	// Check for reversions e.g. (Rev 2) or (Rev A)
	if(preg_match('%\(Rev (\d|[A-Za-z])\)%', $thisGame, $revNum)) {
		if(is_numeric($revNum[1])) {
			$revNum = intval($revNum[1]);
		}else{
			$revNum = ord($revNum[1]);
		}
	}

	$otherVersions = trim(shell_exec("ls -1 \"{$niceName} (\"*\"(Rev \"* 2>/dev/null"));
	if($otherVersions) {
		$otherVersionArray = explode("\n", $otherVersions);
		foreach($otherVersionArray as $otherGame) {
			preg_match('%\(Rev (\d|[A-Za-z])\)%', $otherGame, $thisRev);
			if(is_numeric($thisRev[1])) {
				$thisRev = intval($thisRev[1]);
			}else{
				$thisRev = ord($thisRev[1]);
			}

			if(isset($revNum) && $revNum < $thisRev) {
				// Other version is newer, bin ours
				echo "{$thisGame} has an inferior version number [{$revNum} VS. {$thisRev}] - Moved to Removed folder.\n";
				shell_exec("mv \"{$thisGame}\" Removed/");
				continue 2;
			}
		}
	}

	// Check for reversions e.g. (v1.01)
	if(preg_match('%\(v(\d\.\d)\)%', $thisGame, $revNum)) $revNum = $revNum[1];

	$otherVersions = trim(shell_exec("ls -1 \"{$niceName} (\"*\"(v\"* 2>/dev/null"));
	if($otherVersions) {
		$otherVersionArray = explode("\n", $otherVersions);
		foreach($otherVersionArray as $otherGame) {
			preg_match('%\(v(\d\.\d)\)%', $otherGame, $thisRev);
			$thisRev = $thisRev[1];

			if(isset($revNum) && $revNum < $thisRev) {
				// Other version is newer, bin ours
				echo "{$thisGame} has an inferior version number [{$revNum} VS. {$thisRev}] - Moved to Removed folder.\n";
				shell_exec("mv \"{$thisGame}\" Removed/");
				continue 2;
			}
		}
	}

	// Move "(Track X)" games to a folder to process
	/*
	if(preg_match('%\(Track \d+\)%', $thisGame)) {
		$tracklessName = preg_replace('%\s*\(Track \d+\)%', '', $thisGame);
		$tracklessName = preg_replace('%\.bin$%', '', $tracklessName);
		shell_exec("mv \"{$thisGame}\" Process/");
		shell_exec("mv \"{$tracklessName}.cue\" Process/");
	}
	*/
}

?>
